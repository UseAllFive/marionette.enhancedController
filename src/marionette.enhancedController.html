<!DOCTYPE html><html lang="en"><head><title>src/marionette.enhancedController</title></head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0"><meta name="groc-relative-root" content="../"><meta name="groc-document-path" content="src/marionette.enhancedController"><meta name="groc-project-path" content="src/marionette.enhancedController.js"><meta name="groc-github-url" content="https://github.com/UseAllFive/marionette.enhancedController"><link rel="stylesheet" type="text/css" media="all" href="../assets/style.css"><script type="text/javascript" src="../assets/behavior.js"></script><body><div id="meta"><div class="file-path"><a href="https://github.com/UseAllFive/marionette.enhancedController/blob/master/src/marionette.enhancedController.js">src/marionette.enhancedController.js</a></div></div><div id="document"><div class="segment"><div class="code"><div class="wrapper"><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">factory</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">define</span> <span class="o">===</span> <span class="s1">&#39;function&#39;</span> <span class="o">&amp;&amp;</span> <span class="nx">define</span><span class="p">.</span><span class="nx">amd</span><span class="p">)</span> <span class="p">{</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>AMD. Register as an anonymous module.</p></div></div><div class="code"><div class="wrapper">        <span class="nx">define</span><span class="p">([</span><span class="s1">&#39;marionette&#39;</span><span class="p">,</span> <span class="s1">&#39;backbone&#39;</span><span class="p">,</span> <span class="s1">&#39;jquery&#39;</span><span class="p">,</span> <span class="s1">&#39;underscore&#39;</span><span class="p">],</span> <span class="nx">factory</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Use browser globals. Will fail if they are not yet loaded.</p></div></div><div class="code"><div class="wrapper">        <span class="cm">/*globals Marionette, Backbone, $, _ */</span>
        <span class="nx">factory</span><span class="p">(</span><span class="nx">Marionette</span><span class="p">,</span> <span class="nx">Backbone</span><span class="p">,</span> <span class="nx">$</span><span class="p">,</span> <span class="nx">_</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}(</span><span class="kd">function</span><span class="p">(</span><span class="nx">Marionette</span><span class="p">,</span> <span class="nx">Backbone</span><span class="p">,</span> <span class="nx">$</span><span class="p">,</span> <span class="nx">_</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">LoadingController</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">LoadingView</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">Spinner</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">appControllerLoaded</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">controllerRegistry</span> <span class="o">=</span> <span class="p">{};</span>
    <span class="kd">var</span> <span class="nx">originalFunctions</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">showLoading</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">whenFetched</span><span class="p">;</span>

    <span class="nx">Spinner</span> <span class="o">=</span> <span class="c1">// @include ../tmp/spin.js</span>

    <span class="nx">whenFetched</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">entities</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">xhrs</span><span class="p">;</span>

        <span class="nx">xhrs</span> <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">chain</span><span class="p">([</span><span class="nx">entities</span><span class="p">]).</span><span class="nx">flatten</span><span class="p">().</span><span class="nx">pluck</span><span class="p">(</span><span class="s1">&#39;_fetch&#39;</span><span class="p">).</span><span class="nx">value</span><span class="p">();</span>

        <span class="nx">$</span><span class="p">.</span><span class="nx">when</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">xhrs</span><span class="p">).</span><span class="nx">done</span><span class="p">(</span><span class="nx">callback</span><span class="p">);</span>
    <span class="p">};</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Save a copy of the original functions.</p></div></div><div class="code"><div class="wrapper">    <span class="nx">originalFunctions</span> <span class="o">=</span> <span class="p">{</span>
        <span class="nx">applicationConstructor</span><span class="o">:</span> <span class="nx">Marionette</span><span class="p">.</span><span class="nx">Application</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">constructor</span><span class="p">,</span>
        <span class="nx">controllerConstructor</span><span class="o">:</span> <span class="nx">Marionette</span><span class="p">.</span><span class="nx">Controller</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">constructor</span><span class="p">,</span>
        <span class="nx">destroy</span><span class="o">:</span> <span class="nx">Marionette</span><span class="p">.</span><span class="nx">Controller</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">destroy</span>
    <span class="p">};</span>

    <span class="kd">function</span> <span class="nx">overrideSync</span><span class="p">()</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">_sync</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">sync</span><span class="p">;</span>

        <span class="nx">Backbone</span><span class="p">.</span><span class="nx">sync</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">method</span><span class="p">,</span> <span class="nx">entity</span><span class="p">,</span> <span class="nx">options</span><span class="p">)</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">sync</span><span class="p">;</span>

            <span class="k">if</span> <span class="p">(</span><span class="nx">_</span><span class="p">.</span><span class="nx">isUndefined</span><span class="p">(</span><span class="nx">options</span><span class="p">)</span> <span class="o">||</span> <span class="nx">options</span> <span class="o">===</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">options</span> <span class="o">=</span> <span class="p">{};</span>
            <span class="p">}</span>

            <span class="nx">sync</span> <span class="o">=</span> <span class="nx">_sync</span><span class="p">(</span><span class="nx">method</span><span class="p">,</span> <span class="nx">entity</span><span class="p">,</span> <span class="nx">options</span><span class="p">);</span>
            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">entity</span><span class="p">.</span><span class="nx">_fetch</span> <span class="o">&amp;&amp;</span> <span class="nx">method</span> <span class="o">===</span> <span class="s1">&#39;read&#39;</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">entity</span><span class="p">.</span><span class="nx">_fetch</span> <span class="o">=</span> <span class="nx">sync</span><span class="p">;</span>
            <span class="p">}</span>

            <span class="k">return</span> <span class="nx">sync</span><span class="p">;</span>
        <span class="p">};</span>
    <span class="p">}</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Override Backbone.sync</p></div></div><div class="code"><div class="wrapper">    <span class="nx">overrideSync</span><span class="p">();</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Static function to create a <code>close</code> or <code>destroy</code> function on a
<code>controllerInstance</code>.</p></div></div><div class="code"><div class="wrapper">    <span class="kd">function</span> <span class="nx">overrideDestroyOrCloseFunction</span><span class="p">(</span><span class="nx">controllerInstance</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">functionName</span><span class="p">;</span>
        <span class="kd">var</span> <span class="nx">originalFunction</span><span class="p">;</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Determine if we have a <code>close</code> or a <code>destroy</code> function. The API
changed going to Backbone 2.</p></div></div><div class="code"><div class="wrapper">        <span class="k">if</span> <span class="p">(</span><span class="nx">_</span><span class="p">.</span><span class="nx">isFunction</span><span class="p">(</span><span class="nx">controllerInstance</span><span class="p">.</span><span class="nx">close</span><span class="p">))</span> <span class="p">{</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>&lt; Backbone 2</p></div></div><div class="code"><div class="wrapper">            <span class="nx">functionName</span> <span class="o">=</span> <span class="s1">&#39;close&#39;</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">_</span><span class="p">.</span><span class="nx">isFunction</span><span class="p">(</span><span class="nx">controllerInstance</span><span class="p">.</span><span class="nx">destroy</span><span class="p">))</span> <span class="p">{</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><blockquote>
  <p>= Backbone 2</p>
</blockquote></div></div><div class="code"><div class="wrapper">            <span class="nx">functionName</span> <span class="o">=</span> <span class="s1">&#39;destroy&#39;</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s1">&#39;Could not find a close or destroy method on the controller&#39;</span><span class="p">);</span>
        <span class="p">}</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Save the original function.</p></div></div><div class="code"><div class="wrapper">        <span class="nx">originalFunction</span> <span class="o">=</span> <span class="nx">controllerInstance</span><span class="p">[</span><span class="nx">functionName</span><span class="p">];</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Modify the original function.</p></div></div><div class="code"><div class="wrapper">        <span class="nx">controllerInstance</span><span class="p">[</span><span class="nx">functionName</span><span class="p">]</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
            <span class="k">delete</span> <span class="k">this</span><span class="p">.</span><span class="nx">region</span><span class="p">;</span>
            <span class="k">delete</span> <span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">;</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Remove instance from the registry.</p></div></div><div class="code"><div class="wrapper">            <span class="k">delete</span> <span class="nx">controllerRegistry</span><span class="p">[</span><span class="k">this</span><span class="p">.</span><span class="nx">_instanceId</span><span class="p">];</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Call original function.</p></div></div><div class="code"><div class="wrapper">            <span class="nx">originalFunction</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">arguments</span><span class="p">);</span>
        <span class="p">};</span>
    <span class="p">}</span>

    <span class="nx">Marionette</span><span class="p">.</span><span class="nx">Controller</span> <span class="o">=</span> <span class="nx">Marionette</span><span class="p">.</span><span class="nx">Controller</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><h2 id="constructor">Constructor</h2>

<p>Override <code>Marionette.Controller.constructor</code>. Here, we'll save
the <code>region</code> passed in via <code>options</code> and save a reference to this
controller.</p></div></div><div class="code"><div class="wrapper">        <span class="nx">constructor</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">options</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">options</span> <span class="o">=</span> <span class="nx">options</span> <span class="o">||</span> <span class="p">{};</span>

            <span class="k">if</span> <span class="p">(</span><span class="nx">appControllerLoaded</span><span class="p">)</span> <span class="p">{</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>The app controller has already been loaded.</p></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Define <code>this.region</code> so this controller knows where to show
itself.</p></div></div><div class="code"><div class="wrapper">                <span class="k">this</span><span class="p">.</span><span class="nx">region</span> <span class="o">=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">region</span><span class="p">;</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Save the instance id. This will help with memory leak
tracking.</p></div></div><div class="code"><div class="wrapper">                <span class="k">this</span><span class="p">.</span><span class="nx">_instanceId</span> <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">uniqueId</span><span class="p">(</span><span class="s1">&#39;controller&#39;</span><span class="p">);</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Save instance in the registry.</p></div></div><div class="code"><div class="wrapper">                <span class="nx">controllerRegistry</span><span class="p">[</span><span class="k">this</span><span class="p">.</span><span class="nx">_instanceId</span><span class="p">]</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>The app controller is loading now.</p></div></div><div class="code"><div class="wrapper">                <span class="nx">appControllerLoaded</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
            <span class="p">}</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Override the close or destroy function.</p></div></div><div class="code"><div class="wrapper">            <span class="nx">overrideDestroyOrCloseFunction</span><span class="p">(</span><span class="k">this</span><span class="p">);</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Call the original constructor.</p></div></div><div class="code"><div class="wrapper">            <span class="nx">originalFunctions</span><span class="p">.</span><span class="nx">controllerConstructor</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">arguments</span><span class="p">);</span>
        <span class="p">},</span>

        <span class="nx">show</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">view</span><span class="p">,</span> <span class="nx">options</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">region</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s1">&#39;A controller must be given a region in it\&#39;s options&#39;</span><span class="p">);</span>
            <span class="p">}</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Default <code>options</code> to <code>{}</code></p></div></div><div class="code"><div class="wrapper">            <span class="k">if</span> <span class="p">(</span><span class="nx">_</span><span class="p">.</span><span class="nx">isUndefined</span><span class="p">(</span><span class="nx">options</span><span class="p">)</span> <span class="o">||</span> <span class="nx">options</span> <span class="o">===</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">options</span> <span class="o">=</span> <span class="p">{};</span>
            <span class="p">}</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Set default options</p></div></div><div class="code"><div class="wrapper">            <span class="nx">_</span><span class="p">.</span><span class="nx">defaults</span><span class="p">(</span><span class="nx">options</span><span class="p">,</span> <span class="p">{</span>
                <span class="nx">loading</span><span class="o">:</span> <span class="kc">false</span><span class="p">,</span>
                <span class="nx">region</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">region</span>
            <span class="p">});</span>

            <span class="k">this</span><span class="p">.</span><span class="nx">_setMainView</span><span class="p">(</span><span class="nx">view</span><span class="p">);</span>

            <span class="k">this</span><span class="p">.</span><span class="nx">_manageView</span><span class="p">(</span><span class="nx">view</span><span class="p">,</span> <span class="nx">options</span><span class="p">);</span>
        <span class="p">},</span>

        <span class="nx">_setMainView</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">view</span><span class="p">)</span> <span class="p">{</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Taken verbatim from <a href="https://github.com/brian-mann/sc02-loading-views">backbone rails loading views</a>:</p></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>the first view we show is always going to become the mainView
of our controller (whether its a layout or another view
type).  So if this <em>is</em> a layout, when we show other regions
inside of that layout, we check for the existance of a
mainView first, so our controller is only closed down when
the original mainView is closed.</p></div></div><div class="code"><div class="wrapper">            <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">_mainView</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">return</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">_mainView</span> <span class="o">=</span> <span class="nx">view</span><span class="p">;</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Listen to <code>close</code> and <code>destroy</code> events on the <code>view</code>.
Depending on which version of backbone we're using, a
different functions are called.</p></div></div><div class="code"><div class="wrapper">            <span class="k">this</span><span class="p">.</span><span class="nx">listenTo</span><span class="p">(</span><span class="nx">view</span><span class="p">,</span> <span class="s1">&#39;close&#39;</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">close</span><span class="p">);</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">listenTo</span><span class="p">(</span><span class="nx">view</span><span class="p">,</span> <span class="s1">&#39;destroy&#39;</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">destroy</span><span class="p">);</span>
        <span class="p">},</span>

        <span class="nx">_manageView</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">view</span><span class="p">,</span> <span class="nx">options</span><span class="p">)</span> <span class="p">{</span>

            <span class="k">if</span> <span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">loading</span><span class="p">)</span> <span class="p">{</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Show loading view</p></div></div><div class="code"><div class="wrapper">                <span class="nx">showLoading</span><span class="p">(</span><span class="nx">view</span><span class="p">,</span> <span class="nx">options</span><span class="p">);</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="nx">options</span><span class="p">.</span><span class="nx">region</span><span class="p">.</span><span class="nx">show</span><span class="p">(</span><span class="nx">view</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">});</span>

    <span class="nx">Marionette</span><span class="p">.</span><span class="nx">Controller</span><span class="p">.</span><span class="nx">_registry</span> <span class="o">=</span> <span class="nx">controllerRegistry</span><span class="p">;</span>
    <span class="nx">Marionette</span><span class="p">.</span><span class="nx">Controller</span><span class="p">.</span><span class="nx">_resetRegistry</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Allow develoompent debuggging since this is a development
function.</p></div></div><div class="code"><div class="wrapper">        <span class="c1">//jshint devel: true</span>
        <span class="kd">var</span> <span class="nx">controller</span><span class="p">;</span>
        <span class="kd">var</span> <span class="nx">index</span><span class="p">;</span>
        <span class="kd">var</span> <span class="nx">message</span><span class="p">;</span>
        <span class="kd">var</span> <span class="nx">newCount</span><span class="p">;</span>
        <span class="kd">var</span> <span class="nx">oldCount</span> <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">size</span><span class="p">(</span><span class="nx">controllerRegistry</span><span class="p">);</span>

        <span class="k">for</span> <span class="p">(</span><span class="nx">index</span> <span class="k">in</span> <span class="nx">controllerRegistry</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">controllerRegistry</span><span class="p">.</span><span class="nx">hasOwnProperty</span><span class="p">(</span><span class="nx">index</span><span class="p">))</span> <span class="p">{</span>
                <span class="nx">controller</span> <span class="o">=</span> <span class="nx">controllerRegistry</span><span class="p">[</span><span class="nx">index</span><span class="p">];</span>

                <span class="k">if</span> <span class="p">(</span><span class="nx">controller</span><span class="p">.</span><span class="nx">region</span><span class="p">)</span> <span class="p">{</span>
                    <span class="k">if</span> <span class="p">(</span><span class="nx">controller</span><span class="p">.</span><span class="nx">region</span><span class="p">.</span><span class="nx">empty</span><span class="p">)</span> <span class="p">{</span>
                        <span class="nx">controller</span><span class="p">.</span><span class="nx">region</span><span class="p">.</span><span class="nx">empty</span><span class="p">();</span>
                    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">controller</span><span class="p">.</span><span class="nx">region</span><span class="p">.</span><span class="nx">close</span><span class="p">)</span> <span class="p">{</span>
                        <span class="nx">controller</span><span class="p">.</span><span class="nx">region</span><span class="p">.</span><span class="nx">close</span><span class="p">();</span>
                    <span class="p">}</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="nx">newCount</span> <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">size</span><span class="p">(</span><span class="nx">controllerRegistry</span><span class="p">);</span>

        <span class="nx">message</span> <span class="o">=</span> <span class="s1">&#39;There were &#39;</span> <span class="o">+</span> <span class="nx">oldCount</span> <span class="o">+</span> <span class="s1">&#39; controllers in the registry, there are now &#39;</span> <span class="o">+</span> <span class="nx">newCount</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">newCount</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">console</span><span class="p">.</span><span class="nx">warn</span><span class="p">(</span><span class="nx">message</span><span class="p">,</span> <span class="nx">controllerRegistry</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="nx">console</span><span class="p">.</span><span class="nx">info</span><span class="p">(</span><span class="nx">message</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">};</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><h2 id="show-loading-function">Show loading function</h2></div></div></div><div class="segment"><div class="code"><div class="wrapper">    <span class="nx">showLoading</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">view</span><span class="p">,</span> <span class="nx">options</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">new</span> <span class="nx">LoadingController</span><span class="p">({</span>
            <span class="nx">view</span><span class="o">:</span> <span class="nx">view</span><span class="p">,</span>
            <span class="nx">region</span><span class="o">:</span> <span class="nx">options</span><span class="p">.</span><span class="nx">region</span><span class="p">,</span>
            <span class="nx">config</span><span class="o">:</span> <span class="nx">options</span>
        <span class="p">});</span>
    <span class="p">};</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><h2 id="loading-view">Loading View</h2></div></div></div><div class="segment"><div class="code"><div class="wrapper">    <span class="nx">LoadingView</span> <span class="o">=</span> <span class="nx">Marionette</span><span class="p">.</span><span class="nx">ItemView</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
        <span class="nx">template</span><span class="o">:</span> <span class="kc">false</span><span class="p">,</span>

        <span class="nx">className</span><span class="o">:</span> <span class="s1">&#39;loading-container&#39;</span><span class="p">,</span>

        <span class="nx">onShow</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">opts</span><span class="p">;</span>
            <span class="nx">opts</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">_getOptions</span><span class="p">();</span>

            <span class="k">this</span><span class="p">.</span><span class="nx">spinner</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Spinner</span><span class="p">(</span><span class="nx">opts</span><span class="p">);</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">spinner</span><span class="p">.</span><span class="nx">spin</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">$el</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span>
        <span class="p">},</span>

        <span class="nx">onClose</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">spinner</span><span class="p">.</span><span class="nx">stop</span><span class="p">();</span>
        <span class="p">},</span>

        <span class="nx">_getOptions</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
            <span class="k">return</span> <span class="p">{</span>
                <span class="nx">lines</span><span class="o">:</span> <span class="mi">10</span><span class="p">,</span>
                <span class="nx">length</span><span class="o">:</span> <span class="mi">6</span><span class="p">,</span>
                <span class="nx">width</span><span class="o">:</span> <span class="mf">2.5</span><span class="p">,</span>
                <span class="nx">radius</span><span class="o">:</span> <span class="mi">7</span><span class="p">,</span>
                <span class="nx">corners</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span>
                <span class="nx">rotate</span><span class="o">:</span> <span class="mi">9</span><span class="p">,</span>
                <span class="nx">direction</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span>
                <span class="nx">color</span><span class="o">:</span> <span class="s1">&#39;#000&#39;</span><span class="p">,</span>
                <span class="nx">speed</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span>
                <span class="nx">trail</span><span class="o">:</span> <span class="mi">60</span><span class="p">,</span>
                <span class="nx">shadow</span><span class="o">:</span> <span class="kc">false</span><span class="p">,</span>
                <span class="nx">hwaccel</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
                <span class="nx">className</span><span class="o">:</span> <span class="s1">&#39;spinner&#39;</span><span class="p">,</span>
                <span class="nx">zIndex</span><span class="o">:</span> <span class="mi">2</span><span class="nx">e9</span><span class="p">,</span>
                <span class="nx">top</span><span class="o">:</span> <span class="s1">&#39;auto&#39;</span><span class="p">,</span>
                <span class="nx">left</span><span class="o">:</span> <span class="s1">&#39;auto&#39;</span>
            <span class="p">};</span>
        <span class="p">}</span>
    <span class="p">});</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><h2 id="loading-controller">Loading Controller</h2></div></div></div><div class="segment"><div class="code"><div class="wrapper">    <span class="nx">LoadingController</span> <span class="o">=</span> <span class="nx">Marionette</span><span class="p">.</span><span class="nx">Controller</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
        <span class="nx">initialize</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">options</span><span class="p">)</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">config</span><span class="p">;</span>
            <span class="kd">var</span> <span class="nx">loadingView</span><span class="p">;</span>
            <span class="kd">var</span> <span class="nx">view</span><span class="p">;</span>

            <span class="nx">view</span> <span class="o">=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">view</span><span class="p">;</span>
            <span class="nx">config</span> <span class="o">=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">config</span><span class="p">;</span>
            <span class="nx">config</span> <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">isBoolean</span><span class="p">(</span><span class="nx">config</span><span class="p">)</span> <span class="o">?</span> <span class="p">{}</span> <span class="o">:</span> <span class="nx">config</span><span class="p">;</span>

            <span class="nx">_</span><span class="p">.</span><span class="nx">defaults</span><span class="p">(</span><span class="nx">config</span><span class="p">,</span> <span class="p">{</span>
                <span class="nx">debug</span><span class="o">:</span> <span class="kc">false</span><span class="p">,</span>
                <span class="nx">entities</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">getEntities</span><span class="p">(</span><span class="nx">view</span><span class="p">),</span>
                <span class="nx">loadingType</span><span class="o">:</span> <span class="s1">&#39;spinner&#39;</span><span class="p">,</span>
                <span class="nx">loadingMessage</span><span class="o">:</span> <span class="kc">null</span>
            <span class="p">});</span>

            <span class="k">switch</span> <span class="p">(</span><span class="nx">config</span><span class="p">.</span><span class="nx">loadingType</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">case</span> <span class="s1">&#39;opacity&#39;</span><span class="o">:</span>
                    <span class="k">this</span><span class="p">.</span><span class="nx">region</span><span class="p">.</span><span class="nx">show</span><span class="p">(</span><span class="nx">view</span><span class="p">);</span>
                    <span class="k">this</span><span class="p">.</span><span class="nx">region</span><span class="p">.</span><span class="nx">currentView</span><span class="p">.</span><span class="nx">$el</span><span class="p">.</span><span class="nx">css</span><span class="p">(</span><span class="s1">&#39;opacity&#39;</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">);</span>
                    <span class="k">break</span><span class="p">;</span>
                <span class="k">case</span> <span class="s1">&#39;spinner&#39;</span><span class="o">:</span>
                    <span class="nx">loadingView</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">getLoadingView</span><span class="p">();</span>
                    <span class="k">this</span><span class="p">.</span><span class="nx">show</span><span class="p">(</span><span class="nx">loadingView</span><span class="p">);</span>
                    <span class="k">break</span><span class="p">;</span>
                <span class="k">default</span><span class="o">:</span>
                    <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s1">&#39;Invalid loadingType&#39;</span><span class="p">);</span>
            <span class="p">}</span>

            <span class="k">this</span><span class="p">.</span><span class="nx">showRealView</span><span class="p">(</span><span class="nx">view</span><span class="p">,</span> <span class="nx">loadingView</span><span class="p">,</span> <span class="nx">config</span><span class="p">);</span>
        <span class="p">},</span>

        <span class="nx">showRealView</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">realView</span><span class="p">,</span> <span class="nx">loadingView</span><span class="p">,</span> <span class="nx">config</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">whenFetched</span><span class="p">(</span><span class="nx">config</span><span class="p">.</span><span class="nx">entities</span><span class="p">,</span> <span class="nx">_</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>...after the entities are fetched, execute this callback
================================================================ //
If the region we are trying to insert is not the loadingView then
we know the user has navigated to a different page while the loading
view was still open. In that case, we know to manually close the original
view so its controller is also closed.  We also prevent showing the real
view (which would snap the user back to the old view unexpectedly)
================================================================ //</p></div></div><div class="code"><div class="wrapper">                <span class="k">switch</span> <span class="p">(</span><span class="nx">config</span><span class="p">.</span><span class="nx">loadingType</span><span class="p">)</span> <span class="p">{</span>
                    <span class="k">case</span> <span class="s1">&#39;opacity&#39;</span><span class="o">:</span>
                        <span class="k">this</span><span class="p">.</span><span class="nx">region</span><span class="p">.</span><span class="nx">currentView</span><span class="p">.</span><span class="nx">$el</span><span class="p">.</span><span class="nx">css</span><span class="p">(</span><span class="s1">&#39;opacity&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">);</span>
                        <span class="k">break</span><span class="p">;</span>
                    <span class="k">case</span> <span class="s1">&#39;spinner&#39;</span><span class="o">:</span>
                        <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">region</span><span class="p">.</span><span class="nx">currentView</span> <span class="o">!==</span> <span class="nx">loadingView</span><span class="p">)</span> <span class="p">{</span>
                            <span class="k">return</span> <span class="nx">realView</span><span class="p">.</span><span class="nx">close</span><span class="p">();</span>
                        <span class="p">}</span>
                <span class="p">}</span>
                <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">config</span><span class="p">.</span><span class="nx">debug</span><span class="p">)</span> <span class="p">{</span>
                    <span class="k">this</span><span class="p">.</span><span class="nx">show</span><span class="p">(</span><span class="nx">realView</span><span class="p">);</span>
                <span class="p">}</span>
            <span class="p">},</span> <span class="k">this</span><span class="p">));</span>
        <span class="p">},</span>

        <span class="nx">getEntities</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">view</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nx">_</span><span class="p">.</span><span class="nx">chain</span><span class="p">(</span><span class="nx">view</span><span class="p">).</span><span class="nx">pick</span><span class="p">(</span><span class="s1">&#39;model&#39;</span><span class="p">,</span> <span class="s1">&#39;collection&#39;</span><span class="p">).</span><span class="nx">toArray</span><span class="p">().</span><span class="nx">compact</span><span class="p">().</span><span class="nx">value</span><span class="p">();</span>
        <span class="p">},</span>

        <span class="nx">getLoadingView</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
            <span class="k">return</span> <span class="k">new</span> <span class="nx">LoadingView</span><span class="p">();</span>
        <span class="p">}</span>
    <span class="p">});</span>
<span class="p">}));</span></div></div></div></div></body></html>