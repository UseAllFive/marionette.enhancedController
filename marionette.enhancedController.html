<!DOCTYPE html><html lang="en"><head><title>marionette.enhancedController</title></head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0"><meta name="groc-relative-root" content=""><meta name="groc-document-path" content="marionette.enhancedController"><meta name="groc-project-path" content="lib/marionette.enhancedController.js"><meta name="groc-github-url" content="https://github.com/UseAllFive/marionette.enhancedController"><link rel="stylesheet" type="text/css" media="all" href="assets/style.css"><script type="text/javascript" src="assets/behavior.js"></script><body><div id="meta"><div class="file-path"><a href="https://github.com/UseAllFive/marionette.enhancedController/blob/master/lib/marionette.enhancedController.js">lib/marionette.enhancedController.js</a></div></div><div id="document"><div class="segment"><div class="comments "><div class="wrapper"><h2 id="marionetteenhancedcontroller">marionette.enhancedController</h2>

<p>v1.1.5
Brought to you by <a href="http://www.useallfive.com">Use All Five, Inc.</a></p>

<pre><code>Author: Justin Anastos &lt;janastos@useallfive.com&gt;
Author URI: [http://www.useallfive.com](http://www.useallfive.com)
Repository: https://github.com/UseAllFive/marionette.enhancedController
</code></pre>

<p>Add <code>.show</code> method to a <code>Marionette.Controller</code> and provide loading views.
Inspired by <a href="http://www.backbonerails.com/screencasts/loading-views">Backbone Rails, Loading Views</a>.</p></div></div><div class="code"><div class="wrapper"><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">factory</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">define</span> <span class="o">===</span> <span class="s1">&#39;function&#39;</span> <span class="o">&amp;&amp;</span> <span class="nx">define</span><span class="p">.</span><span class="nx">amd</span><span class="p">)</span> <span class="p">{</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>AMD. Register as an anonymous module.</p></div></div><div class="code"><div class="wrapper">        <span class="nx">define</span><span class="p">([</span><span class="s1">&#39;marionette&#39;</span><span class="p">,</span> <span class="s1">&#39;backbone&#39;</span><span class="p">,</span> <span class="s1">&#39;jquery&#39;</span><span class="p">,</span> <span class="s1">&#39;underscore&#39;</span><span class="p">],</span> <span class="nx">factory</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Use browser globals. Will fail if they are not yet loaded.</p></div></div><div class="code"><div class="wrapper">        <span class="cm">/*globals Marionette, Backbone, $, _ */</span>
        <span class="nx">factory</span><span class="p">(</span><span class="nx">Marionette</span><span class="p">,</span> <span class="nx">Backbone</span><span class="p">,</span> <span class="nx">$</span><span class="p">,</span> <span class="nx">_</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}(</span><span class="kd">function</span><span class="p">(</span><span class="nx">Marionette</span><span class="p">,</span> <span class="nx">Backbone</span><span class="p">,</span> <span class="nx">$</span><span class="p">,</span> <span class="nx">_</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">LoadingController</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">LoadingView</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">Spinner</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">appControllerLoaded</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">controllerRegistry</span> <span class="o">=</span> <span class="p">{};</span>
    <span class="kd">var</span> <span class="nx">originalFunctions</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">showLoading</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">whenFetched</span><span class="p">;</span>

    <span class="nx">Spinner</span> <span class="o">=</span> <span class="cm">/**</span>
<span class="cm">               * Copyright (c) 2011-2014 Felix Gnass</span>
<span class="cm">               * Licensed under the MIT license</span>
<span class="cm">               */</span> <span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
                <span class="s2">&quot;use strict&quot;</span><span class="p">;</span>
                <span class="kd">var</span> <span class="nx">prefixes</span> <span class="o">=</span> <span class="p">[</span> <span class="s2">&quot;webkit&quot;</span><span class="p">,</span> <span class="s2">&quot;Moz&quot;</span><span class="p">,</span> <span class="s2">&quot;ms&quot;</span><span class="p">,</span> <span class="s2">&quot;O&quot;</span> <span class="p">],</span> <span class="nx">animations</span> <span class="o">=</span> <span class="p">{},</span> <span class="nx">useCssAnimations</span><span class="p">;</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Whether to use CSS animations or setTimeout 
Utility function to create elements. If no tag name is given,
a DIV is created. Optionally properties can be passed.</p></div></div><div class="code"><div class="wrapper">                <span class="kd">function</span> <span class="nx">createEl</span><span class="p">(</span><span class="nx">tag</span><span class="p">,</span> <span class="nx">prop</span><span class="p">)</span> <span class="p">{</span>
                  <span class="kd">var</span> <span class="nx">el</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="nx">tag</span> <span class="o">||</span> <span class="s2">&quot;div&quot;</span><span class="p">),</span> <span class="nx">n</span><span class="p">;</span>
                  <span class="k">for</span> <span class="p">(</span><span class="nx">n</span> <span class="k">in</span> <span class="nx">prop</span><span class="p">)</span> <span class="nx">el</span><span class="p">[</span><span class="nx">n</span><span class="p">]</span> <span class="o">=</span> <span class="nx">prop</span><span class="p">[</span><span class="nx">n</span><span class="p">];</span>
                  <span class="k">return</span> <span class="nx">el</span><span class="p">;</span>
                <span class="p">}</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Appends children and returns the parent.</p></div></div><div class="code"><div class="wrapper">                <span class="kd">function</span> <span class="nx">ins</span><span class="p">(</span><span class="nx">parent</span><span class="p">)</span> <span class="p">{</span>
                  <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="nx">n</span> <span class="o">=</span> <span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">n</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="nx">parent</span><span class="p">.</span><span class="nx">appendChild</span><span class="p">(</span><span class="nx">arguments</span><span class="p">[</span><span class="nx">i</span><span class="p">]);</span>
                  <span class="k">return</span> <span class="nx">parent</span><span class="p">;</span>
                <span class="p">}</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Insert a new stylesheet to hold the @keyframe or VML rules.</p></div></div><div class="code"><div class="wrapper">                <span class="kd">var</span> <span class="nx">sheet</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
                  <span class="kd">var</span> <span class="nx">el</span> <span class="o">=</span> <span class="nx">createEl</span><span class="p">(</span><span class="s2">&quot;style&quot;</span><span class="p">,</span> <span class="p">{</span>
                    <span class="nx">type</span><span class="o">:</span> <span class="s2">&quot;text/css&quot;</span>
                  <span class="p">});</span>
                  <span class="nx">ins</span><span class="p">(</span><span class="nb">document</span><span class="p">.</span><span class="nx">getElementsByTagName</span><span class="p">(</span><span class="s2">&quot;head&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span> <span class="nx">el</span><span class="p">);</span>
                  <span class="k">return</span> <span class="nx">el</span><span class="p">.</span><span class="nx">sheet</span> <span class="o">||</span> <span class="nx">el</span><span class="p">.</span><span class="nx">styleSheet</span><span class="p">;</span>
                <span class="p">}();</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Creates an opacity keyframe animation rule and returns its name.
Since most mobile Webkits have timing issues with animation-delay,
we create separate rules for each line/segment.</p></div></div><div class="code"><div class="wrapper">                <span class="kd">function</span> <span class="nx">addAnimation</span><span class="p">(</span><span class="nx">alpha</span><span class="p">,</span> <span class="nx">trail</span><span class="p">,</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">lines</span><span class="p">)</span> <span class="p">{</span>
                  <span class="kd">var</span> <span class="nx">name</span> <span class="o">=</span> <span class="p">[</span> <span class="s2">&quot;opacity&quot;</span><span class="p">,</span> <span class="nx">trail</span><span class="p">,</span> <span class="o">~~</span><span class="p">(</span><span class="nx">alpha</span> <span class="o">*</span> <span class="mi">100</span><span class="p">),</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">lines</span> <span class="p">].</span><span class="nx">join</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">),</span> <span class="nx">start</span> <span class="o">=</span> <span class="p">.</span><span class="mi">01</span> <span class="o">+</span> <span class="nx">i</span> <span class="o">/</span> <span class="nx">lines</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span> <span class="nx">z</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">max</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="nx">alpha</span><span class="p">)</span> <span class="o">/</span> <span class="nx">trail</span> <span class="o">*</span> <span class="p">(</span><span class="mi">100</span> <span class="o">-</span> <span class="nx">start</span><span class="p">),</span> <span class="nx">alpha</span><span class="p">),</span> <span class="nx">prefix</span> <span class="o">=</span> <span class="nx">useCssAnimations</span><span class="p">.</span><span class="nx">substring</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nx">useCssAnimations</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="s2">&quot;Animation&quot;</span><span class="p">)).</span><span class="nx">toLowerCase</span><span class="p">(),</span> <span class="nx">pre</span> <span class="o">=</span> <span class="nx">prefix</span> <span class="o">&amp;&amp;</span> <span class="s2">&quot;-&quot;</span> <span class="o">+</span> <span class="nx">prefix</span> <span class="o">+</span> <span class="s2">&quot;-&quot;</span> <span class="o">||</span> <span class="s2">&quot;&quot;</span><span class="p">;</span>
                  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">animations</span><span class="p">[</span><span class="nx">name</span><span class="p">])</span> <span class="p">{</span>
                    <span class="nx">sheet</span><span class="p">.</span><span class="nx">insertRule</span><span class="p">(</span><span class="s2">&quot;@&quot;</span> <span class="o">+</span> <span class="nx">pre</span> <span class="o">+</span> <span class="s2">&quot;keyframes &quot;</span> <span class="o">+</span> <span class="nx">name</span> <span class="o">+</span> <span class="s2">&quot;{&quot;</span> <span class="o">+</span> <span class="s2">&quot;0%{opacity:&quot;</span> <span class="o">+</span> <span class="nx">z</span> <span class="o">+</span> <span class="s2">&quot;}&quot;</span> <span class="o">+</span> <span class="nx">start</span> <span class="o">+</span> <span class="s2">&quot;%{opacity:&quot;</span> <span class="o">+</span> <span class="nx">alpha</span> <span class="o">+</span> <span class="s2">&quot;}&quot;</span> <span class="o">+</span> <span class="p">(</span><span class="nx">start</span> <span class="o">+</span> <span class="p">.</span><span class="mi">01</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;%{opacity:1}&quot;</span> <span class="o">+</span> <span class="p">(</span><span class="nx">start</span> <span class="o">+</span> <span class="nx">trail</span><span class="p">)</span> <span class="o">%</span> <span class="mi">100</span> <span class="o">+</span> <span class="s2">&quot;%{opacity:&quot;</span> <span class="o">+</span> <span class="nx">alpha</span> <span class="o">+</span> <span class="s2">&quot;}&quot;</span> <span class="o">+</span> <span class="s2">&quot;100%{opacity:&quot;</span> <span class="o">+</span> <span class="nx">z</span> <span class="o">+</span> <span class="s2">&quot;}&quot;</span> <span class="o">+</span> <span class="s2">&quot;}&quot;</span><span class="p">,</span> <span class="nx">sheet</span><span class="p">.</span><span class="nx">cssRules</span><span class="p">.</span><span class="nx">length</span><span class="p">);</span>
                    <span class="nx">animations</span><span class="p">[</span><span class="nx">name</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
                  <span class="p">}</span>
                  <span class="k">return</span> <span class="nx">name</span><span class="p">;</span>
                <span class="p">}</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Tries various vendor prefixes and returns the first supported property.</p></div></div><div class="code"><div class="wrapper">                <span class="kd">function</span> <span class="nx">vendor</span><span class="p">(</span><span class="nx">el</span><span class="p">,</span> <span class="nx">prop</span><span class="p">)</span> <span class="p">{</span>
                  <span class="kd">var</span> <span class="nx">s</span> <span class="o">=</span> <span class="nx">el</span><span class="p">.</span><span class="nx">style</span><span class="p">,</span> <span class="nx">pp</span><span class="p">,</span> <span class="nx">i</span><span class="p">;</span>
                  <span class="nx">prop</span> <span class="o">=</span> <span class="nx">prop</span><span class="p">.</span><span class="nx">charAt</span><span class="p">(</span><span class="mi">0</span><span class="p">).</span><span class="nx">toUpperCase</span><span class="p">()</span> <span class="o">+</span> <span class="nx">prop</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
                  <span class="k">for</span> <span class="p">(</span><span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">prefixes</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
                    <span class="nx">pp</span> <span class="o">=</span> <span class="nx">prefixes</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">+</span> <span class="nx">prop</span><span class="p">;</span>
                    <span class="k">if</span> <span class="p">(</span><span class="nx">s</span><span class="p">[</span><span class="nx">pp</span><span class="p">]</span> <span class="o">!==</span> <span class="kc">undefined</span><span class="p">)</span> <span class="k">return</span> <span class="nx">pp</span><span class="p">;</span>
                  <span class="p">}</span>
                  <span class="k">if</span> <span class="p">(</span><span class="nx">s</span><span class="p">[</span><span class="nx">prop</span><span class="p">]</span> <span class="o">!==</span> <span class="kc">undefined</span><span class="p">)</span> <span class="k">return</span> <span class="nx">prop</span><span class="p">;</span>
                <span class="p">}</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Sets multiple style properties at once.</p></div></div><div class="code"><div class="wrapper">                <span class="kd">function</span> <span class="nx">css</span><span class="p">(</span><span class="nx">el</span><span class="p">,</span> <span class="nx">prop</span><span class="p">)</span> <span class="p">{</span>
                  <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">n</span> <span class="k">in</span> <span class="nx">prop</span><span class="p">)</span> <span class="nx">el</span><span class="p">.</span><span class="nx">style</span><span class="p">[</span><span class="nx">vendor</span><span class="p">(</span><span class="nx">el</span><span class="p">,</span> <span class="nx">n</span><span class="p">)</span> <span class="o">||</span> <span class="nx">n</span><span class="p">]</span> <span class="o">=</span> <span class="nx">prop</span><span class="p">[</span><span class="nx">n</span><span class="p">];</span>
                  <span class="k">return</span> <span class="nx">el</span><span class="p">;</span>
                <span class="p">}</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Fills in default values.</p></div></div><div class="code"><div class="wrapper">                <span class="kd">function</span> <span class="nx">merge</span><span class="p">(</span><span class="nx">obj</span><span class="p">)</span> <span class="p">{</span>
                  <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
                    <span class="kd">var</span> <span class="nx">def</span> <span class="o">=</span> <span class="nx">arguments</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
                    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">n</span> <span class="k">in</span> <span class="nx">def</span><span class="p">)</span> <span class="k">if</span> <span class="p">(</span><span class="nx">obj</span><span class="p">[</span><span class="nx">n</span><span class="p">]</span> <span class="o">===</span> <span class="kc">undefined</span><span class="p">)</span> <span class="nx">obj</span><span class="p">[</span><span class="nx">n</span><span class="p">]</span> <span class="o">=</span> <span class="nx">def</span><span class="p">[</span><span class="nx">n</span><span class="p">];</span>
                  <span class="p">}</span>
                  <span class="k">return</span> <span class="nx">obj</span><span class="p">;</span>
                <span class="p">}</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Returns the absolute page-offset of the given element.</p></div></div><div class="code"><div class="wrapper">                <span class="kd">function</span> <span class="nx">pos</span><span class="p">(</span><span class="nx">el</span><span class="p">)</span> <span class="p">{</span>
                  <span class="kd">var</span> <span class="nx">o</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="nx">x</span><span class="o">:</span> <span class="nx">el</span><span class="p">.</span><span class="nx">offsetLeft</span><span class="p">,</span>
                    <span class="nx">y</span><span class="o">:</span> <span class="nx">el</span><span class="p">.</span><span class="nx">offsetTop</span>
                  <span class="p">};</span>
                  <span class="k">while</span> <span class="p">(</span><span class="nx">el</span> <span class="o">=</span> <span class="nx">el</span><span class="p">.</span><span class="nx">offsetParent</span><span class="p">)</span> <span class="nx">o</span><span class="p">.</span><span class="nx">x</span> <span class="o">+=</span> <span class="nx">el</span><span class="p">.</span><span class="nx">offsetLeft</span><span class="p">,</span> <span class="nx">o</span><span class="p">.</span><span class="nx">y</span> <span class="o">+=</span> <span class="nx">el</span><span class="p">.</span><span class="nx">offsetTop</span><span class="p">;</span>
                  <span class="k">return</span> <span class="nx">o</span><span class="p">;</span>
                <span class="p">}</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Returns the line color from the given string or array.</p></div></div><div class="code"><div class="wrapper">                <span class="kd">function</span> <span class="nx">getColor</span><span class="p">(</span><span class="nx">color</span><span class="p">,</span> <span class="nx">idx</span><span class="p">)</span> <span class="p">{</span>
                  <span class="k">return</span> <span class="k">typeof</span> <span class="nx">color</span> <span class="o">==</span> <span class="s2">&quot;string&quot;</span> <span class="o">?</span> <span class="nx">color</span> <span class="o">:</span> <span class="nx">color</span><span class="p">[</span><span class="nx">idx</span> <span class="o">%</span> <span class="nx">color</span><span class="p">.</span><span class="nx">length</span><span class="p">];</span>
                <span class="p">}</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Built-in defaults</p></div></div><div class="code"><div class="wrapper">                <span class="kd">var</span> <span class="nx">defaults</span> <span class="o">=</span> <span class="p">{</span>
                  <span class="nx">lines</span><span class="o">:</span> <span class="mi">12</span><span class="p">,</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>The number of lines to draw</p></div></div><div class="code"><div class="wrapper">                  <span class="nx">length</span><span class="o">:</span> <span class="mi">7</span><span class="p">,</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>The length of each line</p></div></div><div class="code"><div class="wrapper">                  <span class="nx">width</span><span class="o">:</span> <span class="mi">5</span><span class="p">,</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>The line thickness</p></div></div><div class="code"><div class="wrapper">                  <span class="nx">radius</span><span class="o">:</span> <span class="mi">10</span><span class="p">,</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>The radius of the inner circle</p></div></div><div class="code"><div class="wrapper">                  <span class="nx">rotate</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Rotation offset</p></div></div><div class="code"><div class="wrapper">                  <span class="nx">corners</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Roundness (0..1)</p></div></div><div class="code"><div class="wrapper">                  <span class="nx">color</span><span class="o">:</span> <span class="s2">&quot;#000&quot;</span><span class="p">,</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><h1 id="rgb-or-rrggbb">rgb or #rrggbb</h1></div></div></div><div class="segment"><div class="code"><div class="wrapper">                  <span class="nx">direction</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>1: clockwise, -1: counterclockwise</p></div></div><div class="code"><div class="wrapper">                  <span class="nx">speed</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Rounds per second</p></div></div><div class="code"><div class="wrapper">                  <span class="nx">trail</span><span class="o">:</span> <span class="mi">100</span><span class="p">,</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Afterglow percentage</p></div></div><div class="code"><div class="wrapper">                  <span class="nx">opacity</span><span class="o">:</span> <span class="mi">1</span> <span class="o">/</span> <span class="mi">4</span><span class="p">,</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Opacity of the lines</p></div></div><div class="code"><div class="wrapper">                  <span class="nx">fps</span><span class="o">:</span> <span class="mi">20</span><span class="p">,</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Frames per second when using setTimeout()</p></div></div><div class="code"><div class="wrapper">                  <span class="nx">zIndex</span><span class="o">:</span> <span class="mi">2</span><span class="nx">e9</span><span class="p">,</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Use a high z-index by default</p></div></div><div class="code"><div class="wrapper">                  <span class="nx">className</span><span class="o">:</span> <span class="s2">&quot;spinner&quot;</span><span class="p">,</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>CSS class to assign to the element</p></div></div><div class="code"><div class="wrapper">                  <span class="nx">top</span><span class="o">:</span> <span class="s2">&quot;50%&quot;</span><span class="p">,</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>center vertically</p></div></div><div class="code"><div class="wrapper">                  <span class="nx">left</span><span class="o">:</span> <span class="s2">&quot;50%&quot;</span><span class="p">,</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>center horizontally</p></div></div><div class="code"><div class="wrapper">                  <span class="nx">position</span><span class="o">:</span> <span class="s2">&quot;absolute&quot;</span>
                <span class="p">};</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>The constructor </p></div></div><div class="code"><div class="wrapper">                <span class="kd">function</span> <span class="nx">Spinner</span><span class="p">(</span><span class="nx">o</span><span class="p">)</span> <span class="p">{</span>
                  <span class="k">this</span><span class="p">.</span><span class="nx">opts</span> <span class="o">=</span> <span class="nx">merge</span><span class="p">(</span><span class="nx">o</span> <span class="o">||</span> <span class="p">{},</span> <span class="nx">Spinner</span><span class="p">.</span><span class="nx">defaults</span><span class="p">,</span> <span class="nx">defaults</span><span class="p">);</span>
                <span class="p">}</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Global defaults that override the built-ins:</p></div></div><div class="code"><div class="wrapper">                <span class="nx">Spinner</span><span class="p">.</span><span class="nx">defaults</span> <span class="o">=</span> <span class="p">{};</span>
                <span class="nx">merge</span><span class="p">(</span><span class="nx">Spinner</span><span class="p">.</span><span class="nx">prototype</span><span class="p">,</span> <span class="p">{</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Adds the spinner to the given target element. If this instance is already
spinning, it is automatically removed from its previous target b calling
stop() internally.</p></div></div><div class="code"><div class="wrapper">                  <span class="nx">spin</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">target</span><span class="p">)</span> <span class="p">{</span>
                    <span class="k">this</span><span class="p">.</span><span class="nx">stop</span><span class="p">();</span>
                    <span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">,</span> <span class="nx">o</span> <span class="o">=</span> <span class="nx">self</span><span class="p">.</span><span class="nx">opts</span><span class="p">,</span> <span class="nx">el</span> <span class="o">=</span> <span class="nx">self</span><span class="p">.</span><span class="nx">el</span> <span class="o">=</span> <span class="nx">css</span><span class="p">(</span><span class="nx">createEl</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="p">{</span>
                      <span class="nx">className</span><span class="o">:</span> <span class="nx">o</span><span class="p">.</span><span class="nx">className</span>
                    <span class="p">}),</span> <span class="p">{</span>
                      <span class="nx">position</span><span class="o">:</span> <span class="nx">o</span><span class="p">.</span><span class="nx">position</span><span class="p">,</span>
                      <span class="nx">width</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span>
                      <span class="nx">zIndex</span><span class="o">:</span> <span class="nx">o</span><span class="p">.</span><span class="nx">zIndex</span>
                    <span class="p">}),</span> <span class="nx">mid</span> <span class="o">=</span> <span class="nx">o</span><span class="p">.</span><span class="nx">radius</span> <span class="o">+</span> <span class="nx">o</span><span class="p">.</span><span class="nx">length</span> <span class="o">+</span> <span class="nx">o</span><span class="p">.</span><span class="nx">width</span><span class="p">;</span>
                    <span class="nx">css</span><span class="p">(</span><span class="nx">el</span><span class="p">,</span> <span class="p">{</span>
                      <span class="nx">left</span><span class="o">:</span> <span class="nx">o</span><span class="p">.</span><span class="nx">left</span><span class="p">,</span>
                      <span class="nx">top</span><span class="o">:</span> <span class="nx">o</span><span class="p">.</span><span class="nx">top</span>
                    <span class="p">});</span>
                    <span class="k">if</span> <span class="p">(</span><span class="nx">target</span><span class="p">)</span> <span class="p">{</span>
                      <span class="nx">target</span><span class="p">.</span><span class="nx">insertBefore</span><span class="p">(</span><span class="nx">el</span><span class="p">,</span> <span class="nx">target</span><span class="p">.</span><span class="nx">firstChild</span> <span class="o">||</span> <span class="kc">null</span><span class="p">);</span>
                    <span class="p">}</span>
                    <span class="nx">el</span><span class="p">.</span><span class="nx">setAttribute</span><span class="p">(</span><span class="s2">&quot;role&quot;</span><span class="p">,</span> <span class="s2">&quot;progressbar&quot;</span><span class="p">);</span>
                    <span class="nx">self</span><span class="p">.</span><span class="nx">lines</span><span class="p">(</span><span class="nx">el</span><span class="p">,</span> <span class="nx">self</span><span class="p">.</span><span class="nx">opts</span><span class="p">);</span>
                    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">useCssAnimations</span><span class="p">)</span> <span class="p">{</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>No CSS animation support, use setTimeout() instead</p></div></div><div class="code"><div class="wrapper">                      <span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">start</span> <span class="o">=</span> <span class="p">(</span><span class="nx">o</span><span class="p">.</span><span class="nx">lines</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="nx">o</span><span class="p">.</span><span class="nx">direction</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="nx">alpha</span><span class="p">,</span> <span class="nx">fps</span> <span class="o">=</span> <span class="nx">o</span><span class="p">.</span><span class="nx">fps</span><span class="p">,</span> <span class="nx">f</span> <span class="o">=</span> <span class="nx">fps</span> <span class="o">/</span> <span class="nx">o</span><span class="p">.</span><span class="nx">speed</span><span class="p">,</span> <span class="nx">ostep</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="nx">o</span><span class="p">.</span><span class="nx">opacity</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="nx">f</span> <span class="o">*</span> <span class="nx">o</span><span class="p">.</span><span class="nx">trail</span> <span class="o">/</span> <span class="mi">100</span><span class="p">),</span> <span class="nx">astep</span> <span class="o">=</span> <span class="nx">f</span> <span class="o">/</span> <span class="nx">o</span><span class="p">.</span><span class="nx">lines</span><span class="p">;</span>
                      <span class="p">(</span><span class="kd">function</span> <span class="nx">anim</span><span class="p">()</span> <span class="p">{</span>
                        <span class="nx">i</span><span class="o">++</span><span class="p">;</span>
                        <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">j</span> <span class="o">&lt;</span> <span class="nx">o</span><span class="p">.</span><span class="nx">lines</span><span class="p">;</span> <span class="nx">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
                          <span class="nx">alpha</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">max</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="p">(</span><span class="nx">i</span> <span class="o">+</span> <span class="p">(</span><span class="nx">o</span><span class="p">.</span><span class="nx">lines</span> <span class="o">-</span> <span class="nx">j</span><span class="p">)</span> <span class="o">*</span> <span class="nx">astep</span><span class="p">)</span> <span class="o">%</span> <span class="nx">f</span> <span class="o">*</span> <span class="nx">ostep</span><span class="p">,</span> <span class="nx">o</span><span class="p">.</span><span class="nx">opacity</span><span class="p">);</span>
                          <span class="nx">self</span><span class="p">.</span><span class="nx">opacity</span><span class="p">(</span><span class="nx">el</span><span class="p">,</span> <span class="nx">j</span> <span class="o">*</span> <span class="nx">o</span><span class="p">.</span><span class="nx">direction</span> <span class="o">+</span> <span class="nx">start</span><span class="p">,</span> <span class="nx">alpha</span><span class="p">,</span> <span class="nx">o</span><span class="p">);</span>
                        <span class="p">}</span>
                        <span class="nx">self</span><span class="p">.</span><span class="nx">timeout</span> <span class="o">=</span> <span class="nx">self</span><span class="p">.</span><span class="nx">el</span> <span class="o">&amp;&amp;</span> <span class="nx">setTimeout</span><span class="p">(</span><span class="nx">anim</span><span class="p">,</span> <span class="o">~~</span><span class="p">(</span><span class="mi">1</span><span class="nx">e3</span> <span class="o">/</span> <span class="nx">fps</span><span class="p">));</span>
                      <span class="p">})();</span>
                    <span class="p">}</span>
                    <span class="k">return</span> <span class="nx">self</span><span class="p">;</span>
                  <span class="p">},</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Stops and removes the Spinner.</p></div></div><div class="code"><div class="wrapper">                  <span class="nx">stop</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
                    <span class="kd">var</span> <span class="nx">el</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">el</span><span class="p">;</span>
                    <span class="k">if</span> <span class="p">(</span><span class="nx">el</span><span class="p">)</span> <span class="p">{</span>
                      <span class="nx">clearTimeout</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">timeout</span><span class="p">);</span>
                      <span class="k">if</span> <span class="p">(</span><span class="nx">el</span><span class="p">.</span><span class="nx">parentNode</span><span class="p">)</span> <span class="nx">el</span><span class="p">.</span><span class="nx">parentNode</span><span class="p">.</span><span class="nx">removeChild</span><span class="p">(</span><span class="nx">el</span><span class="p">);</span>
                      <span class="k">this</span><span class="p">.</span><span class="nx">el</span> <span class="o">=</span> <span class="kc">undefined</span><span class="p">;</span>
                    <span class="p">}</span>
                    <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
                  <span class="p">},</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Internal method that draws the individual lines. Will be overwritten
in VML fallback mode below.</p></div></div><div class="code"><div class="wrapper">                  <span class="nx">lines</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">el</span><span class="p">,</span> <span class="nx">o</span><span class="p">)</span> <span class="p">{</span>
                    <span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">start</span> <span class="o">=</span> <span class="p">(</span><span class="nx">o</span><span class="p">.</span><span class="nx">lines</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="nx">o</span><span class="p">.</span><span class="nx">direction</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="nx">seg</span><span class="p">;</span>
                    <span class="kd">function</span> <span class="nx">fill</span><span class="p">(</span><span class="nx">color</span><span class="p">,</span> <span class="nx">shadow</span><span class="p">)</span> <span class="p">{</span>
                      <span class="k">return</span> <span class="nx">css</span><span class="p">(</span><span class="nx">createEl</span><span class="p">(),</span> <span class="p">{</span>
                        <span class="nx">position</span><span class="o">:</span> <span class="s2">&quot;absolute&quot;</span><span class="p">,</span>
                        <span class="nx">width</span><span class="o">:</span> <span class="nx">o</span><span class="p">.</span><span class="nx">length</span> <span class="o">+</span> <span class="nx">o</span><span class="p">.</span><span class="nx">width</span> <span class="o">+</span> <span class="s2">&quot;px&quot;</span><span class="p">,</span>
                        <span class="nx">height</span><span class="o">:</span> <span class="nx">o</span><span class="p">.</span><span class="nx">width</span> <span class="o">+</span> <span class="s2">&quot;px&quot;</span><span class="p">,</span>
                        <span class="nx">background</span><span class="o">:</span> <span class="nx">color</span><span class="p">,</span>
                        <span class="nx">boxShadow</span><span class="o">:</span> <span class="nx">shadow</span><span class="p">,</span>
                        <span class="nx">transformOrigin</span><span class="o">:</span> <span class="s2">&quot;left&quot;</span><span class="p">,</span>
                        <span class="nx">transform</span><span class="o">:</span> <span class="s2">&quot;rotate(&quot;</span> <span class="o">+</span> <span class="o">~~</span><span class="p">(</span><span class="mi">360</span> <span class="o">/</span> <span class="nx">o</span><span class="p">.</span><span class="nx">lines</span> <span class="o">*</span> <span class="nx">i</span> <span class="o">+</span> <span class="nx">o</span><span class="p">.</span><span class="nx">rotate</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;deg) translate(&quot;</span> <span class="o">+</span> <span class="nx">o</span><span class="p">.</span><span class="nx">radius</span> <span class="o">+</span> <span class="s2">&quot;px&quot;</span> <span class="o">+</span> <span class="s2">&quot;,0)&quot;</span><span class="p">,</span>
                        <span class="nx">borderRadius</span><span class="o">:</span> <span class="p">(</span><span class="nx">o</span><span class="p">.</span><span class="nx">corners</span> <span class="o">*</span> <span class="nx">o</span><span class="p">.</span><span class="nx">width</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;px&quot;</span>
                      <span class="p">});</span>
                    <span class="p">}</span>
                    <span class="k">for</span> <span class="p">(;</span><span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">o</span><span class="p">.</span><span class="nx">lines</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
                      <span class="nx">seg</span> <span class="o">=</span> <span class="nx">css</span><span class="p">(</span><span class="nx">createEl</span><span class="p">(),</span> <span class="p">{</span>
                        <span class="nx">position</span><span class="o">:</span> <span class="s2">&quot;absolute&quot;</span><span class="p">,</span>
                        <span class="nx">top</span><span class="o">:</span> <span class="mi">1</span> <span class="o">+</span> <span class="o">~</span><span class="p">(</span><span class="nx">o</span><span class="p">.</span><span class="nx">width</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;px&quot;</span><span class="p">,</span>
                        <span class="nx">transform</span><span class="o">:</span> <span class="nx">o</span><span class="p">.</span><span class="nx">hwaccel</span> <span class="o">?</span> <span class="s2">&quot;translate3d(0,0,0)&quot;</span> <span class="o">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
                        <span class="nx">opacity</span><span class="o">:</span> <span class="nx">o</span><span class="p">.</span><span class="nx">opacity</span><span class="p">,</span>
                        <span class="nx">animation</span><span class="o">:</span> <span class="nx">useCssAnimations</span> <span class="o">&amp;&amp;</span> <span class="nx">addAnimation</span><span class="p">(</span><span class="nx">o</span><span class="p">.</span><span class="nx">opacity</span><span class="p">,</span> <span class="nx">o</span><span class="p">.</span><span class="nx">trail</span><span class="p">,</span> <span class="nx">start</span> <span class="o">+</span> <span class="nx">i</span> <span class="o">*</span> <span class="nx">o</span><span class="p">.</span><span class="nx">direction</span><span class="p">,</span> <span class="nx">o</span><span class="p">.</span><span class="nx">lines</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">/</span> <span class="nx">o</span><span class="p">.</span><span class="nx">speed</span> <span class="o">+</span> <span class="s2">&quot;s linear infinite&quot;</span>
                      <span class="p">});</span>
                      <span class="k">if</span> <span class="p">(</span><span class="nx">o</span><span class="p">.</span><span class="nx">shadow</span><span class="p">)</span> <span class="nx">ins</span><span class="p">(</span><span class="nx">seg</span><span class="p">,</span> <span class="nx">css</span><span class="p">(</span><span class="nx">fill</span><span class="p">(</span><span class="s2">&quot;#000&quot;</span><span class="p">,</span> <span class="s2">&quot;0 0 4px &quot;</span> <span class="o">+</span> <span class="s2">&quot;#000&quot;</span><span class="p">),</span> <span class="p">{</span>
                        <span class="nx">top</span><span class="o">:</span> <span class="mi">2</span> <span class="o">+</span> <span class="s2">&quot;px&quot;</span>
                      <span class="p">}));</span>
                      <span class="nx">ins</span><span class="p">(</span><span class="nx">el</span><span class="p">,</span> <span class="nx">ins</span><span class="p">(</span><span class="nx">seg</span><span class="p">,</span> <span class="nx">fill</span><span class="p">(</span><span class="nx">getColor</span><span class="p">(</span><span class="nx">o</span><span class="p">.</span><span class="nx">color</span><span class="p">,</span> <span class="nx">i</span><span class="p">),</span> <span class="s2">&quot;0 0 1px rgba(0,0,0,.1)&quot;</span><span class="p">)));</span>
                    <span class="p">}</span>
                    <span class="k">return</span> <span class="nx">el</span><span class="p">;</span>
                  <span class="p">},</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Internal method that adjusts the opacity of a single line.
Will be overwritten in VML fallback mode below.</p></div></div><div class="code"><div class="wrapper">                  <span class="nx">opacity</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">el</span><span class="p">,</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">val</span><span class="p">)</span> <span class="p">{</span>
                    <span class="k">if</span> <span class="p">(</span><span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">el</span><span class="p">.</span><span class="nx">childNodes</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="nx">el</span><span class="p">.</span><span class="nx">childNodes</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">style</span><span class="p">.</span><span class="nx">opacity</span> <span class="o">=</span> <span class="nx">val</span><span class="p">;</span>
                  <span class="p">}</span>
                <span class="p">});</span>
                <span class="kd">function</span> <span class="nx">initVML</span><span class="p">()</span> <span class="p">{</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Utility function to create a VML tag </p></div></div><div class="code"><div class="wrapper">                  <span class="kd">function</span> <span class="nx">vml</span><span class="p">(</span><span class="nx">tag</span><span class="p">,</span> <span class="nx">attr</span><span class="p">)</span> <span class="p">{</span>
                    <span class="k">return</span> <span class="nx">createEl</span><span class="p">(</span><span class="s2">&quot;&lt;&quot;</span> <span class="o">+</span> <span class="nx">tag</span> <span class="o">+</span> <span class="s1">&#39; xmlns=&quot;urn:schemas-microsoft.com:vml&quot; class=&quot;spin-vml&quot;&gt;&#39;</span><span class="p">,</span> <span class="nx">attr</span><span class="p">);</span>
                  <span class="p">}</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>No CSS transforms but VML support, add a CSS rule for VML elements:</p></div></div><div class="code"><div class="wrapper">                  <span class="nx">sheet</span><span class="p">.</span><span class="nx">addRule</span><span class="p">(</span><span class="s2">&quot;.spin-vml&quot;</span><span class="p">,</span> <span class="s2">&quot;behavior:url(#default#VML)&quot;</span><span class="p">);</span>
                  <span class="nx">Spinner</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">lines</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">el</span><span class="p">,</span> <span class="nx">o</span><span class="p">)</span> <span class="p">{</span>
                    <span class="kd">var</span> <span class="nx">r</span> <span class="o">=</span> <span class="nx">o</span><span class="p">.</span><span class="nx">length</span> <span class="o">+</span> <span class="nx">o</span><span class="p">.</span><span class="nx">width</span><span class="p">,</span> <span class="nx">s</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="nx">r</span><span class="p">;</span>
                    <span class="kd">function</span> <span class="nx">grp</span><span class="p">()</span> <span class="p">{</span>
                      <span class="k">return</span> <span class="nx">css</span><span class="p">(</span><span class="nx">vml</span><span class="p">(</span><span class="s2">&quot;group&quot;</span><span class="p">,</span> <span class="p">{</span>
                        <span class="nx">coordsize</span><span class="o">:</span> <span class="nx">s</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="nx">s</span><span class="p">,</span>
                        <span class="nx">coordorigin</span><span class="o">:</span> <span class="o">-</span><span class="nx">r</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="o">-</span><span class="nx">r</span>
                      <span class="p">}),</span> <span class="p">{</span>
                        <span class="nx">width</span><span class="o">:</span> <span class="nx">s</span><span class="p">,</span>
                        <span class="nx">height</span><span class="o">:</span> <span class="nx">s</span>
                      <span class="p">});</span>
                    <span class="p">}</span>
                    <span class="kd">var</span> <span class="nx">margin</span> <span class="o">=</span> <span class="o">-</span><span class="p">(</span><span class="nx">o</span><span class="p">.</span><span class="nx">width</span> <span class="o">+</span> <span class="nx">o</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">+</span> <span class="s2">&quot;px&quot;</span><span class="p">,</span> <span class="nx">g</span> <span class="o">=</span> <span class="nx">css</span><span class="p">(</span><span class="nx">grp</span><span class="p">(),</span> <span class="p">{</span>
                      <span class="nx">position</span><span class="o">:</span> <span class="s2">&quot;absolute&quot;</span><span class="p">,</span>
                      <span class="nx">top</span><span class="o">:</span> <span class="nx">margin</span><span class="p">,</span>
                      <span class="nx">left</span><span class="o">:</span> <span class="nx">margin</span>
                    <span class="p">}),</span> <span class="nx">i</span><span class="p">;</span>
                    <span class="kd">function</span> <span class="nx">seg</span><span class="p">(</span><span class="nx">i</span><span class="p">,</span> <span class="nx">dx</span><span class="p">,</span> <span class="nx">filter</span><span class="p">)</span> <span class="p">{</span>
                      <span class="nx">ins</span><span class="p">(</span><span class="nx">g</span><span class="p">,</span> <span class="nx">ins</span><span class="p">(</span><span class="nx">css</span><span class="p">(</span><span class="nx">grp</span><span class="p">(),</span> <span class="p">{</span>
                        <span class="nx">rotation</span><span class="o">:</span> <span class="mi">360</span> <span class="o">/</span> <span class="nx">o</span><span class="p">.</span><span class="nx">lines</span> <span class="o">*</span> <span class="nx">i</span> <span class="o">+</span> <span class="s2">&quot;deg&quot;</span><span class="p">,</span>
                        <span class="nx">left</span><span class="o">:</span> <span class="o">~~</span><span class="nx">dx</span>
                      <span class="p">}),</span> <span class="nx">ins</span><span class="p">(</span><span class="nx">css</span><span class="p">(</span><span class="nx">vml</span><span class="p">(</span><span class="s2">&quot;roundrect&quot;</span><span class="p">,</span> <span class="p">{</span>
                        <span class="nx">arcsize</span><span class="o">:</span> <span class="nx">o</span><span class="p">.</span><span class="nx">corners</span>
                      <span class="p">}),</span> <span class="p">{</span>
                        <span class="nx">width</span><span class="o">:</span> <span class="nx">r</span><span class="p">,</span>
                        <span class="nx">height</span><span class="o">:</span> <span class="nx">o</span><span class="p">.</span><span class="nx">width</span><span class="p">,</span>
                        <span class="nx">left</span><span class="o">:</span> <span class="nx">o</span><span class="p">.</span><span class="nx">radius</span><span class="p">,</span>
                        <span class="nx">top</span><span class="o">:</span> <span class="o">-</span><span class="nx">o</span><span class="p">.</span><span class="nx">width</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">,</span>
                        <span class="nx">filter</span><span class="o">:</span> <span class="nx">filter</span>
                      <span class="p">}),</span> <span class="nx">vml</span><span class="p">(</span><span class="s2">&quot;fill&quot;</span><span class="p">,</span> <span class="p">{</span>
                        <span class="nx">color</span><span class="o">:</span> <span class="nx">getColor</span><span class="p">(</span><span class="nx">o</span><span class="p">.</span><span class="nx">color</span><span class="p">,</span> <span class="nx">i</span><span class="p">),</span>
                        <span class="nx">opacity</span><span class="o">:</span> <span class="nx">o</span><span class="p">.</span><span class="nx">opacity</span>
                      <span class="p">}),</span> <span class="nx">vml</span><span class="p">(</span><span class="s2">&quot;stroke&quot;</span><span class="p">,</span> <span class="p">{</span>
                        <span class="nx">opacity</span><span class="o">:</span> <span class="mi">0</span>
                      <span class="p">}))));</span>
                    <span class="p">}</span>
                    <span class="k">if</span> <span class="p">(</span><span class="nx">o</span><span class="p">.</span><span class="nx">shadow</span><span class="p">)</span> <span class="k">for</span> <span class="p">(</span><span class="nx">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;=</span> <span class="nx">o</span><span class="p">.</span><span class="nx">lines</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="nx">seg</span><span class="p">(</span><span class="nx">i</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="s2">&quot;progid:DXImageTransform.Microsoft.Blur(pixelradius=2,makeshadow=1,shadowopacity=.3)&quot;</span><span class="p">);</span>
                    <span class="k">for</span> <span class="p">(</span><span class="nx">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;=</span> <span class="nx">o</span><span class="p">.</span><span class="nx">lines</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="nx">seg</span><span class="p">(</span><span class="nx">i</span><span class="p">);</span>
                    <span class="k">return</span> <span class="nx">ins</span><span class="p">(</span><span class="nx">el</span><span class="p">,</span> <span class="nx">g</span><span class="p">);</span>
                  <span class="p">};</span>
                  <span class="nx">Spinner</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">opacity</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">el</span><span class="p">,</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">val</span><span class="p">,</span> <span class="nx">o</span><span class="p">)</span> <span class="p">{</span>
                    <span class="kd">var</span> <span class="nx">c</span> <span class="o">=</span> <span class="nx">el</span><span class="p">.</span><span class="nx">firstChild</span><span class="p">;</span>
                    <span class="nx">o</span> <span class="o">=</span> <span class="nx">o</span><span class="p">.</span><span class="nx">shadow</span> <span class="o">&amp;&amp;</span> <span class="nx">o</span><span class="p">.</span><span class="nx">lines</span> <span class="o">||</span> <span class="mi">0</span><span class="p">;</span>
                    <span class="k">if</span> <span class="p">(</span><span class="nx">c</span> <span class="o">&amp;&amp;</span> <span class="nx">i</span> <span class="o">+</span> <span class="nx">o</span> <span class="o">&lt;</span> <span class="nx">c</span><span class="p">.</span><span class="nx">childNodes</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="p">{</span>
                      <span class="nx">c</span> <span class="o">=</span> <span class="nx">c</span><span class="p">.</span><span class="nx">childNodes</span><span class="p">[</span><span class="nx">i</span> <span class="o">+</span> <span class="nx">o</span><span class="p">];</span>
                      <span class="nx">c</span> <span class="o">=</span> <span class="nx">c</span> <span class="o">&amp;&amp;</span> <span class="nx">c</span><span class="p">.</span><span class="nx">firstChild</span><span class="p">;</span>
                      <span class="nx">c</span> <span class="o">=</span> <span class="nx">c</span> <span class="o">&amp;&amp;</span> <span class="nx">c</span><span class="p">.</span><span class="nx">firstChild</span><span class="p">;</span>
                      <span class="k">if</span> <span class="p">(</span><span class="nx">c</span><span class="p">)</span> <span class="nx">c</span><span class="p">.</span><span class="nx">opacity</span> <span class="o">=</span> <span class="nx">val</span><span class="p">;</span>
                    <span class="p">}</span>
                  <span class="p">};</span>
                <span class="p">}</span>
                <span class="kd">var</span> <span class="nx">probe</span> <span class="o">=</span> <span class="nx">css</span><span class="p">(</span><span class="nx">createEl</span><span class="p">(</span><span class="s2">&quot;group&quot;</span><span class="p">),</span> <span class="p">{</span>
                  <span class="nx">behavior</span><span class="o">:</span> <span class="s2">&quot;url(#default#VML)&quot;</span>
                <span class="p">});</span>
                <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">vendor</span><span class="p">(</span><span class="nx">probe</span><span class="p">,</span> <span class="s2">&quot;transform&quot;</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nx">probe</span><span class="p">.</span><span class="nx">adj</span><span class="p">)</span> <span class="nx">initVML</span><span class="p">();</span> <span class="k">else</span> <span class="nx">useCssAnimations</span> <span class="o">=</span> <span class="nx">vendor</span><span class="p">(</span><span class="nx">probe</span><span class="p">,</span> <span class="s2">&quot;animation&quot;</span><span class="p">);</span>
                <span class="k">return</span> <span class="nx">Spinner</span><span class="p">;</span>
              <span class="p">})();</span>

    <span class="nx">whenFetched</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">entities</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">xhrs</span><span class="p">;</span>

        <span class="nx">xhrs</span> <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">chain</span><span class="p">([</span><span class="nx">entities</span><span class="p">]).</span><span class="nx">flatten</span><span class="p">().</span><span class="nx">pluck</span><span class="p">(</span><span class="s1">&#39;_fetch&#39;</span><span class="p">).</span><span class="nx">value</span><span class="p">();</span>

        <span class="nx">$</span><span class="p">.</span><span class="nx">when</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">xhrs</span><span class="p">).</span><span class="nx">done</span><span class="p">(</span><span class="nx">callback</span><span class="p">);</span>
    <span class="p">};</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Save a copy of the original functions.</p></div></div><div class="code"><div class="wrapper">    <span class="nx">originalFunctions</span> <span class="o">=</span> <span class="p">{</span>
        <span class="nx">applicationConstructor</span><span class="o">:</span> <span class="nx">Marionette</span><span class="p">.</span><span class="nx">Application</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">constructor</span><span class="p">,</span>
        <span class="nx">controllerConstructor</span><span class="o">:</span> <span class="nx">Marionette</span><span class="p">.</span><span class="nx">Controller</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">constructor</span><span class="p">,</span>
        <span class="nx">destroy</span><span class="o">:</span> <span class="nx">Marionette</span><span class="p">.</span><span class="nx">Controller</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">destroy</span>
    <span class="p">};</span>

    <span class="kd">function</span> <span class="nx">overrideSync</span><span class="p">()</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">_sync</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">sync</span><span class="p">;</span>

        <span class="nx">Backbone</span><span class="p">.</span><span class="nx">sync</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">method</span><span class="p">,</span> <span class="nx">entity</span><span class="p">,</span> <span class="nx">options</span><span class="p">)</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">sync</span><span class="p">;</span>

            <span class="k">if</span> <span class="p">(</span><span class="nx">_</span><span class="p">.</span><span class="nx">isUndefined</span><span class="p">(</span><span class="nx">options</span><span class="p">)</span> <span class="o">||</span> <span class="nx">options</span> <span class="o">===</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">options</span> <span class="o">=</span> <span class="p">{};</span>
            <span class="p">}</span>

            <span class="nx">sync</span> <span class="o">=</span> <span class="nx">_sync</span><span class="p">(</span><span class="nx">method</span><span class="p">,</span> <span class="nx">entity</span><span class="p">,</span> <span class="nx">options</span><span class="p">);</span>
            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">entity</span><span class="p">.</span><span class="nx">_fetch</span> <span class="o">&amp;&amp;</span> <span class="nx">method</span> <span class="o">===</span> <span class="s1">&#39;read&#39;</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">entity</span><span class="p">.</span><span class="nx">_fetch</span> <span class="o">=</span> <span class="nx">sync</span><span class="p">;</span>
            <span class="p">}</span>

            <span class="k">return</span> <span class="nx">sync</span><span class="p">;</span>
        <span class="p">};</span>
    <span class="p">}</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Override Backbone.sync</p></div></div><div class="code"><div class="wrapper">    <span class="nx">overrideSync</span><span class="p">();</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Static function to create a <code>close</code> or <code>destroy</code> function on a
<code>controllerInstance</code>.</p></div></div><div class="code"><div class="wrapper">    <span class="kd">function</span> <span class="nx">overrideDestroyOrCloseFunction</span><span class="p">(</span><span class="nx">controllerInstance</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">functionName</span><span class="p">;</span>
        <span class="kd">var</span> <span class="nx">originalFunction</span><span class="p">;</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Determine if we have a <code>close</code> or a <code>destroy</code> function. The API
changed going to Backbone 2.</p></div></div><div class="code"><div class="wrapper">        <span class="k">if</span> <span class="p">(</span><span class="nx">_</span><span class="p">.</span><span class="nx">isFunction</span><span class="p">(</span><span class="nx">controllerInstance</span><span class="p">.</span><span class="nx">close</span><span class="p">))</span> <span class="p">{</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>&lt; Backbone 2</p></div></div><div class="code"><div class="wrapper">            <span class="nx">functionName</span> <span class="o">=</span> <span class="s1">&#39;close&#39;</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">_</span><span class="p">.</span><span class="nx">isFunction</span><span class="p">(</span><span class="nx">controllerInstance</span><span class="p">.</span><span class="nx">destroy</span><span class="p">))</span> <span class="p">{</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><blockquote>
  <p>= Backbone 2</p>
</blockquote></div></div><div class="code"><div class="wrapper">            <span class="nx">functionName</span> <span class="o">=</span> <span class="s1">&#39;destroy&#39;</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s1">&#39;Could not find a close or destroy method on the controller&#39;</span><span class="p">);</span>
        <span class="p">}</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Save the original function.</p></div></div><div class="code"><div class="wrapper">        <span class="nx">originalFunction</span> <span class="o">=</span> <span class="nx">controllerInstance</span><span class="p">[</span><span class="nx">functionName</span><span class="p">];</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Modify the original function.</p></div></div><div class="code"><div class="wrapper">        <span class="nx">controllerInstance</span><span class="p">[</span><span class="nx">functionName</span><span class="p">]</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
            <span class="k">delete</span> <span class="k">this</span><span class="p">.</span><span class="nx">region</span><span class="p">;</span>
            <span class="k">delete</span> <span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">;</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Remove instance from the registry.</p></div></div><div class="code"><div class="wrapper">            <span class="k">delete</span> <span class="nx">controllerRegistry</span><span class="p">[</span><span class="k">this</span><span class="p">.</span><span class="nx">_instanceId</span><span class="p">];</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Call original function.</p></div></div><div class="code"><div class="wrapper">            <span class="nx">originalFunction</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">arguments</span><span class="p">);</span>
        <span class="p">};</span>
    <span class="p">}</span>

    <span class="nx">Marionette</span><span class="p">.</span><span class="nx">Controller</span> <span class="o">=</span> <span class="nx">Marionette</span><span class="p">.</span><span class="nx">Controller</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><h2 id="constructor">Constructor</h2>

<p>Override <code>Marionette.Controller.constructor</code>. Here, we'll save
the <code>region</code> passed in via <code>options</code> and save a reference to this
controller.</p></div></div><div class="code"><div class="wrapper">        <span class="nx">constructor</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">options</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">options</span> <span class="o">=</span> <span class="nx">options</span> <span class="o">||</span> <span class="p">{};</span>

            <span class="k">if</span> <span class="p">(</span><span class="nx">appControllerLoaded</span><span class="p">)</span> <span class="p">{</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>The app controller has already been loaded.</p></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Define <code>this.region</code> so this controller knows where to show
itself.</p></div></div><div class="code"><div class="wrapper">                <span class="k">this</span><span class="p">.</span><span class="nx">region</span> <span class="o">=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">region</span><span class="p">;</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Save the instance id. This will help with memory leak
tracking.</p></div></div><div class="code"><div class="wrapper">                <span class="k">this</span><span class="p">.</span><span class="nx">_instanceId</span> <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">uniqueId</span><span class="p">(</span><span class="s1">&#39;controller&#39;</span><span class="p">);</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Save instance in the registry.</p></div></div><div class="code"><div class="wrapper">                <span class="nx">controllerRegistry</span><span class="p">[</span><span class="k">this</span><span class="p">.</span><span class="nx">_instanceId</span><span class="p">]</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>The app controller is loading now.</p></div></div><div class="code"><div class="wrapper">                <span class="nx">appControllerLoaded</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
            <span class="p">}</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Override the close or destroy function.</p></div></div><div class="code"><div class="wrapper">            <span class="nx">overrideDestroyOrCloseFunction</span><span class="p">(</span><span class="k">this</span><span class="p">);</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Call the original constructor.</p></div></div><div class="code"><div class="wrapper">            <span class="nx">originalFunctions</span><span class="p">.</span><span class="nx">controllerConstructor</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">arguments</span><span class="p">);</span>
        <span class="p">},</span>

        <span class="nx">show</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">view</span><span class="p">,</span> <span class="nx">options</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">region</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s1">&#39;A controller must be given a region in it\&#39;s options&#39;</span><span class="p">);</span>
            <span class="p">}</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Default <code>options</code> to <code>{}</code></p></div></div><div class="code"><div class="wrapper">            <span class="k">if</span> <span class="p">(</span><span class="nx">_</span><span class="p">.</span><span class="nx">isUndefined</span><span class="p">(</span><span class="nx">options</span><span class="p">)</span> <span class="o">||</span> <span class="nx">options</span> <span class="o">===</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">options</span> <span class="o">=</span> <span class="p">{};</span>
            <span class="p">}</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Set default options</p></div></div><div class="code"><div class="wrapper">            <span class="nx">_</span><span class="p">.</span><span class="nx">defaults</span><span class="p">(</span><span class="nx">options</span><span class="p">,</span> <span class="p">{</span>
                <span class="nx">loading</span><span class="o">:</span> <span class="kc">false</span><span class="p">,</span>
                <span class="nx">region</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">region</span>
            <span class="p">});</span>

            <span class="k">this</span><span class="p">.</span><span class="nx">_setMainView</span><span class="p">(</span><span class="nx">view</span><span class="p">);</span>

            <span class="k">this</span><span class="p">.</span><span class="nx">_manageView</span><span class="p">(</span><span class="nx">view</span><span class="p">,</span> <span class="nx">options</span><span class="p">);</span>
        <span class="p">},</span>

        <span class="nx">_setMainView</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">view</span><span class="p">)</span> <span class="p">{</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Taken verbatim from <a href="https://github.com/brian-mann/sc02-loading-views">backbone rails loading views</a>:</p></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>the first view we show is always going to become the mainView
of our controller (whether its a layout or another view
type).  So if this <em>is</em> a layout, when we show other regions
inside of that layout, we check for the existance of a
mainView first, so our controller is only closed down when
the original mainView is closed.</p></div></div><div class="code"><div class="wrapper">            <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">_mainView</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">return</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">_mainView</span> <span class="o">=</span> <span class="nx">view</span><span class="p">;</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Listen to <code>close</code> and <code>destroy</code> events on the <code>view</code>.
Depending on which version of backbone we're using, a
different functions are called.</p></div></div><div class="code"><div class="wrapper">            <span class="k">this</span><span class="p">.</span><span class="nx">listenTo</span><span class="p">(</span><span class="nx">view</span><span class="p">,</span> <span class="s1">&#39;close&#39;</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">close</span><span class="p">);</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">listenTo</span><span class="p">(</span><span class="nx">view</span><span class="p">,</span> <span class="s1">&#39;destroy&#39;</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">destroy</span><span class="p">);</span>
        <span class="p">},</span>

        <span class="nx">_manageView</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">view</span><span class="p">,</span> <span class="nx">options</span><span class="p">)</span> <span class="p">{</span>

            <span class="k">if</span> <span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">loading</span><span class="p">)</span> <span class="p">{</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Show loading view</p></div></div><div class="code"><div class="wrapper">                <span class="nx">showLoading</span><span class="p">(</span><span class="nx">view</span><span class="p">,</span> <span class="nx">options</span><span class="p">);</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="nx">options</span><span class="p">.</span><span class="nx">region</span><span class="p">.</span><span class="nx">show</span><span class="p">(</span><span class="nx">view</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">});</span>

    <span class="nx">Marionette</span><span class="p">.</span><span class="nx">Controller</span><span class="p">.</span><span class="nx">_registry</span> <span class="o">=</span> <span class="nx">controllerRegistry</span><span class="p">;</span>
    <span class="nx">Marionette</span><span class="p">.</span><span class="nx">Controller</span><span class="p">.</span><span class="nx">_resetRegistry</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Allow develoompent debuggging since this is a development
function.</p></div></div><div class="code"><div class="wrapper">        <span class="c1">//jshint devel: true</span>
        <span class="kd">var</span> <span class="nx">controller</span><span class="p">;</span>
        <span class="kd">var</span> <span class="nx">index</span><span class="p">;</span>
        <span class="kd">var</span> <span class="nx">message</span><span class="p">;</span>
        <span class="kd">var</span> <span class="nx">newCount</span><span class="p">;</span>
        <span class="kd">var</span> <span class="nx">oldCount</span> <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">size</span><span class="p">(</span><span class="nx">controllerRegistry</span><span class="p">);</span>

        <span class="k">for</span> <span class="p">(</span><span class="nx">index</span> <span class="k">in</span> <span class="nx">controllerRegistry</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">controllerRegistry</span><span class="p">.</span><span class="nx">hasOwnProperty</span><span class="p">(</span><span class="nx">index</span><span class="p">))</span> <span class="p">{</span>
                <span class="nx">controller</span> <span class="o">=</span> <span class="nx">controllerRegistry</span><span class="p">[</span><span class="nx">index</span><span class="p">];</span>

                <span class="k">if</span> <span class="p">(</span><span class="nx">controller</span><span class="p">.</span><span class="nx">region</span><span class="p">)</span> <span class="p">{</span>
                    <span class="k">if</span> <span class="p">(</span><span class="nx">controller</span><span class="p">.</span><span class="nx">region</span><span class="p">.</span><span class="nx">empty</span><span class="p">)</span> <span class="p">{</span>
                        <span class="nx">controller</span><span class="p">.</span><span class="nx">region</span><span class="p">.</span><span class="nx">empty</span><span class="p">();</span>
                    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">controller</span><span class="p">.</span><span class="nx">region</span><span class="p">.</span><span class="nx">close</span><span class="p">)</span> <span class="p">{</span>
                        <span class="nx">controller</span><span class="p">.</span><span class="nx">region</span><span class="p">.</span><span class="nx">close</span><span class="p">();</span>
                    <span class="p">}</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="nx">newCount</span> <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">size</span><span class="p">(</span><span class="nx">controllerRegistry</span><span class="p">);</span>

        <span class="nx">message</span> <span class="o">=</span> <span class="s1">&#39;There were &#39;</span> <span class="o">+</span> <span class="nx">oldCount</span> <span class="o">+</span> <span class="s1">&#39; controllers in the registry, there are now &#39;</span> <span class="o">+</span> <span class="nx">newCount</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">newCount</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">console</span><span class="p">.</span><span class="nx">warn</span><span class="p">(</span><span class="nx">message</span><span class="p">,</span> <span class="nx">controllerRegistry</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="nx">console</span><span class="p">.</span><span class="nx">info</span><span class="p">(</span><span class="nx">message</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">};</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><h2 id="show-loading-function">Show loading function</h2></div></div></div><div class="segment"><div class="code"><div class="wrapper">    <span class="nx">showLoading</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">view</span><span class="p">,</span> <span class="nx">options</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">new</span> <span class="nx">LoadingController</span><span class="p">({</span>
            <span class="nx">view</span><span class="o">:</span> <span class="nx">view</span><span class="p">,</span>
            <span class="nx">region</span><span class="o">:</span> <span class="nx">options</span><span class="p">.</span><span class="nx">region</span><span class="p">,</span>
            <span class="nx">config</span><span class="o">:</span> <span class="nx">options</span>
        <span class="p">});</span>
    <span class="p">};</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><h2 id="loading-view">Loading View</h2></div></div></div><div class="segment"><div class="code"><div class="wrapper">    <span class="nx">LoadingView</span> <span class="o">=</span> <span class="nx">Marionette</span><span class="p">.</span><span class="nx">ItemView</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
        <span class="nx">template</span><span class="o">:</span> <span class="kc">false</span><span class="p">,</span>

        <span class="nx">className</span><span class="o">:</span> <span class="s1">&#39;loading-container&#39;</span><span class="p">,</span>

        <span class="nx">onShow</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">opts</span><span class="p">;</span>
            <span class="nx">opts</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">_getOptions</span><span class="p">();</span>

            <span class="k">this</span><span class="p">.</span><span class="nx">spinner</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Spinner</span><span class="p">(</span><span class="nx">opts</span><span class="p">);</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">spinner</span><span class="p">.</span><span class="nx">spin</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">$el</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span>
        <span class="p">},</span>

        <span class="nx">onClose</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">spinner</span><span class="p">.</span><span class="nx">stop</span><span class="p">();</span>
        <span class="p">},</span>

        <span class="nx">_getOptions</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
            <span class="k">return</span> <span class="p">{</span>
                <span class="nx">lines</span><span class="o">:</span> <span class="mi">10</span><span class="p">,</span>
                <span class="nx">length</span><span class="o">:</span> <span class="mi">6</span><span class="p">,</span>
                <span class="nx">width</span><span class="o">:</span> <span class="mf">2.5</span><span class="p">,</span>
                <span class="nx">radius</span><span class="o">:</span> <span class="mi">7</span><span class="p">,</span>
                <span class="nx">corners</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span>
                <span class="nx">rotate</span><span class="o">:</span> <span class="mi">9</span><span class="p">,</span>
                <span class="nx">direction</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span>
                <span class="nx">color</span><span class="o">:</span> <span class="s1">&#39;#000&#39;</span><span class="p">,</span>
                <span class="nx">speed</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span>
                <span class="nx">trail</span><span class="o">:</span> <span class="mi">60</span><span class="p">,</span>
                <span class="nx">shadow</span><span class="o">:</span> <span class="kc">false</span><span class="p">,</span>
                <span class="nx">hwaccel</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
                <span class="nx">className</span><span class="o">:</span> <span class="s1">&#39;spinner&#39;</span><span class="p">,</span>
                <span class="nx">zIndex</span><span class="o">:</span> <span class="mi">2</span><span class="nx">e9</span><span class="p">,</span>
                <span class="nx">top</span><span class="o">:</span> <span class="s1">&#39;auto&#39;</span><span class="p">,</span>
                <span class="nx">left</span><span class="o">:</span> <span class="s1">&#39;auto&#39;</span>
            <span class="p">};</span>
        <span class="p">}</span>
    <span class="p">});</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><h2 id="loading-controller">Loading Controller</h2></div></div></div><div class="segment"><div class="code"><div class="wrapper">    <span class="nx">LoadingController</span> <span class="o">=</span> <span class="nx">Marionette</span><span class="p">.</span><span class="nx">Controller</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
        <span class="nx">initialize</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">options</span><span class="p">)</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">config</span><span class="p">;</span>
            <span class="kd">var</span> <span class="nx">loadingView</span><span class="p">;</span>
            <span class="kd">var</span> <span class="nx">view</span><span class="p">;</span>

            <span class="nx">view</span> <span class="o">=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">view</span><span class="p">;</span>
            <span class="nx">config</span> <span class="o">=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">config</span><span class="p">;</span>
            <span class="nx">config</span> <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">isBoolean</span><span class="p">(</span><span class="nx">config</span><span class="p">)</span> <span class="o">?</span> <span class="p">{}</span> <span class="o">:</span> <span class="nx">config</span><span class="p">;</span>

            <span class="nx">_</span><span class="p">.</span><span class="nx">defaults</span><span class="p">(</span><span class="nx">config</span><span class="p">,</span> <span class="p">{</span>
                <span class="nx">debug</span><span class="o">:</span> <span class="kc">false</span><span class="p">,</span>
                <span class="nx">entities</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">getEntities</span><span class="p">(</span><span class="nx">view</span><span class="p">),</span>
                <span class="nx">loadingType</span><span class="o">:</span> <span class="s1">&#39;spinner&#39;</span><span class="p">,</span>
                <span class="nx">loadingMessage</span><span class="o">:</span> <span class="kc">null</span>
            <span class="p">});</span>

            <span class="k">switch</span> <span class="p">(</span><span class="nx">config</span><span class="p">.</span><span class="nx">loadingType</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">case</span> <span class="s1">&#39;opacity&#39;</span><span class="o">:</span>
                    <span class="k">this</span><span class="p">.</span><span class="nx">region</span><span class="p">.</span><span class="nx">show</span><span class="p">(</span><span class="nx">view</span><span class="p">);</span>
                    <span class="k">this</span><span class="p">.</span><span class="nx">region</span><span class="p">.</span><span class="nx">currentView</span><span class="p">.</span><span class="nx">$el</span><span class="p">.</span><span class="nx">css</span><span class="p">(</span><span class="s1">&#39;opacity&#39;</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">);</span>
                    <span class="k">break</span><span class="p">;</span>
                <span class="k">case</span> <span class="s1">&#39;spinner&#39;</span><span class="o">:</span>
                    <span class="nx">loadingView</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">getLoadingView</span><span class="p">();</span>
                    <span class="k">this</span><span class="p">.</span><span class="nx">show</span><span class="p">(</span><span class="nx">loadingView</span><span class="p">);</span>
                    <span class="k">break</span><span class="p">;</span>
                <span class="k">default</span><span class="o">:</span>
                    <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s1">&#39;Invalid loadingType&#39;</span><span class="p">);</span>
            <span class="p">}</span>

            <span class="k">this</span><span class="p">.</span><span class="nx">showRealView</span><span class="p">(</span><span class="nx">view</span><span class="p">,</span> <span class="nx">loadingView</span><span class="p">,</span> <span class="nx">config</span><span class="p">);</span>
        <span class="p">},</span>

        <span class="nx">showRealView</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">realView</span><span class="p">,</span> <span class="nx">loadingView</span><span class="p">,</span> <span class="nx">config</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">whenFetched</span><span class="p">(</span><span class="nx">config</span><span class="p">.</span><span class="nx">entities</span><span class="p">,</span> <span class="nx">_</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>...after the entities are fetched, execute this callback
================================================================ //
If the region we are trying to insert is not the loadingView then
we know the user has navigated to a different page while the loading
view was still open. In that case, we know to manually close the original
view so its controller is also closed.  We also prevent showing the real
view (which would snap the user back to the old view unexpectedly)
================================================================ //</p></div></div><div class="code"><div class="wrapper">                <span class="k">switch</span> <span class="p">(</span><span class="nx">config</span><span class="p">.</span><span class="nx">loadingType</span><span class="p">)</span> <span class="p">{</span>
                    <span class="k">case</span> <span class="s1">&#39;opacity&#39;</span><span class="o">:</span>
                        <span class="k">this</span><span class="p">.</span><span class="nx">region</span><span class="p">.</span><span class="nx">currentView</span><span class="p">.</span><span class="nx">$el</span><span class="p">.</span><span class="nx">css</span><span class="p">(</span><span class="s1">&#39;opacity&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">);</span>
                        <span class="k">break</span><span class="p">;</span>
                    <span class="k">case</span> <span class="s1">&#39;spinner&#39;</span><span class="o">:</span>
                        <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">region</span><span class="p">.</span><span class="nx">currentView</span> <span class="o">!==</span> <span class="nx">loadingView</span><span class="p">)</span> <span class="p">{</span>
                            <span class="k">return</span> <span class="nx">realView</span><span class="p">.</span><span class="nx">close</span><span class="p">();</span>
                        <span class="p">}</span>
                <span class="p">}</span>
                <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">config</span><span class="p">.</span><span class="nx">debug</span><span class="p">)</span> <span class="p">{</span>
                    <span class="k">this</span><span class="p">.</span><span class="nx">show</span><span class="p">(</span><span class="nx">realView</span><span class="p">);</span>
                <span class="p">}</span>
            <span class="p">},</span> <span class="k">this</span><span class="p">));</span>
        <span class="p">},</span>

        <span class="nx">getEntities</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">view</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nx">_</span><span class="p">.</span><span class="nx">chain</span><span class="p">(</span><span class="nx">view</span><span class="p">).</span><span class="nx">pick</span><span class="p">(</span><span class="s1">&#39;model&#39;</span><span class="p">,</span> <span class="s1">&#39;collection&#39;</span><span class="p">).</span><span class="nx">toArray</span><span class="p">().</span><span class="nx">compact</span><span class="p">().</span><span class="nx">value</span><span class="p">();</span>
        <span class="p">},</span>

        <span class="nx">getLoadingView</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
            <span class="k">return</span> <span class="k">new</span> <span class="nx">LoadingView</span><span class="p">();</span>
        <span class="p">}</span>
    <span class="p">});</span>
<span class="p">}));</span></div></div></div></div></body></html>